<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Berita (Admin) - <%= news.title %>
    </title>
    <link rel="stylesheet" href="/berita/style.css" />
</head>

<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <a href="./dashboard" style="display: flex; justify-content: center;">
                <img src="/berita/img/logo.png" alt="Logo DeNews" />
            </a>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a href="./dashboard" class="nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="./list" class="nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="9" x2="21" y2="9"></line>
                        <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    Manajemen Berita
                </a>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <a href="./list" class="back-link"
            style="text-decoration: none; color: inherit; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 20px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Kembali
        </a>

        <div style="max-width: 900px; margin: 0 auto; padding-bottom: 50px;">
            <article class="main-article-content">
                <!-- Hero Image -->
                <% if (news.imagePath) { %>
                    <img src="<%= news.imagePath.replace('public/', '/berita/') %>" alt="<%= news.title %>"
                        class="detail-image" style="margin-top: 0; max-height: 400px; object-fit: cover; width: 100%;">
                    <% } %>

                        <header class="detail-header">
                            <h1 class="detail-title" style="font-size: 32px; margin: 20px 0;">
                                <%= news.title %>
                            </h1>
                            <div class="detail-meta"
                                style="display: flex; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <span style="display: flex; align-items: center; gap: 5px">
                                    Oleh: <%= news.authorName %>
                                </span>
                                <span>|</span>
                                <span>
                                    <%= new Date(news.createdAt).toLocaleDateString('id-ID', { day: 'numeric' ,
                                        month: 'long' , year: 'numeric' }) %>
                                </span>
                                <span>|</span>
                                <span>Kategori: <%= news.category %></span>
                                <span>|</span>

                                <div class="dropdown">
                                    <button class="badge badge-<%= news.status.toLowerCase() %> dropdown-toggle"
                                        type="button" onclick="toggleDropdown(this)">
                                        <%= news.status %>
                                    </button>
                                    <div class="dropdown-menu">
                                        <div class="dropdown-item"
                                            onclick="updateNewsStatus('<%= news.id %>', 'PUBLISHED')">
                                            <span class="status-dot published"></span> Publish
                                        </div>
                                        <div class="dropdown-item"
                                            onclick="updateNewsStatus('<%= news.id %>', 'DRAFT')">
                                            <span class="status-dot draft"></span> Draft
                                        </div>
                                        <div class="dropdown-item"
                                            onclick="updateNewsStatus('<%= news.id %>', 'ARCHIVED')">
                                            <span class="status-dot archived"></span> Archived
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <div class="detail-content">
                            <% if (news.contentBlocks && news.contentBlocks.length> 0) { %>
                                <% news.contentBlocks.forEach(function(block) { %>
                                    <% if (block.blockType==='PARAGRAPH' ) { %>
                                        <p>
                                            <%= block.contentValue %>
                                        </p>
                                        <% } else if (block.blockType==='SUBHEADING' ) { %>
                                            <h2
                                                style="font-size: 24px; font-weight: bold; margin-top: 30px; margin-bottom: 15px;">
                                                <%= block.contentValue %>
                                            </h2>
                                            <% } else if (block.blockType==='IMAGE' ) { %>
                                                <figure style="margin: 30px 0;">
                                                    <img src="<%= block.contentValue.replace('public/', '/berita/') %>"
                                                        class="detail-image"
                                                        alt="<%= block.caption || 'Gambar Berita' %>"
                                                        style="width: 100%; border-radius: 8px;">
                                                    <% if (block.caption) { %>
                                                        <figcaption class="caption"
                                                            style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;">
                                                            <%= block.caption %>
                                                        </figcaption>
                                                        <% } %>
                                                </figure>
                                                <% } else if (block.blockType==='VIDEO' ) { %>
                                                    <div class="video-container" style="margin: 30px 0;">
                                                        <iframe width="100%" height="400"
                                                            src="<%= block.contentValue %>" frameborder="0"
                                                            allowfullscreen style="border-radius: 8px;"></iframe>
                                                        <% if (block.caption) { %>
                                                            <p class="caption"
                                                                style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;">
                                                                <%= block.caption %>
                                                            </p>
                                                            <% } %>
                                                    </div>
                                                    <% } %>
                                                        <% }); %>
                                                            <% } else { %>
                                                                <p>Konten berita tidak tersedia.</p>
                                                                <% } %>
                        </div>
            </article>
        </div>
    </main>

    <script>
        // Close dropdowns when clicking outside
        window.onclick = function (event) {
            if (!event.target.closest('.dropdown')) {
                var dropdowns = document.getElementsByClassName("dropdown-menu");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function toggleDropdown(button) {
            // Close all other dropdowns first
            var dropdowns = document.getElementsByClassName("dropdown-menu");
            for (var i = 0; i < dropdowns.length; i++) {
                if (dropdowns[i] !== button.nextElementSibling) {
                    dropdowns[i].classList.remove('show');
                }
            }
            // Toggle the clicked one
            button.nextElementSibling.classList.toggle("show");
        }

        async function updateNewsStatus(id, newStatus) {
            if (!confirm(`Ubah status menjadi ${newStatus}?`)) return;

            try {
                // Path relative to the current URL (/berita/admin/:slug)
                // Need to go up one level to reach /berita/admin/update/:id
                const response = await fetch(`./update/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Gagal memperbarui status: ' + result.error);
                }
            } catch (error) {
                console.error(error);
                alert('Terjadi kesalahan saat memperbarui status.');
            }
        }
    </script>
</body>

</html>