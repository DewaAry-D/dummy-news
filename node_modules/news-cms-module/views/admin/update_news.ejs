<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tambah Berita - DeNews</title>
  <link rel="stylesheet" href="/berita/style.css" />
</head>

<body>
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="logo">
      <a href="index.html" style="display: flex; justify-content: center;"><img src="/berita/img/logo.png"
          alt="Logo DeNews" /></a>
    </div>

    <ul class="nav-menu">
      <li class="nav-item">
        <a href="./dashboard" class="nav-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          Dashboard
        </a>
      </li>
      <li class="nav-item">
        <a href="management.html" class="nav-link active">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
          Manajemen Berita
        </a>
      </li>
    </ul>


  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <a href="/berita/cms-admin/list" class="back-link">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Kembali
    </a>

    <div class="form-card" style="max-width: 100%;">
      <form id="newsForm">
        <h3>Detail Berita</h3>
        <br />

        <div class="form-group">
          <label class="form-label">Judul <span class="text-red">*</span></label>
          <input type="text" class="form-control" id="newsTitle" value="<%= data.title %>" required />
        </div>

        <div class="form-group">
          <label class="form-label">Nama Author <span class="text-red">*</span></label>
          <input type="text" class="form-control" id="newsAuthor" value="<%= data.authorName %>" required />
        </div>

        <div class="form-group">
          <label class="form-label">Kategori <span class="text-red">*</span></label>
          <select class="form-control" id="newsCategory" required>
            <option value="<%= data.category %>"><%= data.category %></option>
            
            <% const categories = ["Ekonomi", "Hiburan", "Olahraga", "Nasional"]; %>
            
            <% categories.forEach(cat => { %>
              <option value="<%= cat %>" <%= data.category === cat ? 'selected' : '' %>>
                <%= cat %>
              </option>
            <% }); %>
            
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Gambar Thumbnail (Kosongkan jika tidak ingin ganti)</label>
          <div style="margin-bottom: 10px;">
              <small>Thumbnail saat ini:</small><br>
              <img src="<%= data.imagePath %>" alt="Thumbnail" style="height: 100px; border-radius: 8px;">
          </div>
          <div class="input-group">
            <input type="file" class="form-control" id="newsThumbnail" accept="image/*" />
          </div>
        </div>

        <h4>Konten Berita</h4>
        <div id="contentContainer">
          <% data.contentBlocks.forEach((block, index) => { %>
            <div class="content-block" data-type="<%= block.blockType.toLowerCase() %>">
              <button type="button" class="remove-block-btn" onclick="this.parentElement.remove()">üóëÔ∏è</button>
              <label class="form-label">
                <%= block.blockType === 'PARAGRAPH' ? 'üìù Paragraf' : 
                    block.blockType === 'VIDEO' ? 'üé• Video (URL)' : 
                    block.blockType === 'IMAGE' ? 'üñºÔ∏è Gambar Konten' : 'H2 Sub Heading' %>
              </label>
              
              <div>
                <% if (block.blockType === 'PARAGRAPH') { %>
                  <textarea class="form-control" name="contentValue" rows="4"><%= block.contentValue %></textarea>
                <% } else if (block.blockType === 'VIDEO') { %>
                  <input type="text" class="form-control mb-2" name="contentValue" value="<%= block.contentValue %>">
                  <input type="text" class="form-control" name="contentCaption" value="<%= block.caption %>">
                <% } else if (block.blockType === 'IMAGE') { %>
                    <div class="mb-2">
                      <small>Gambar saat ini:</small><br>
                      <img src="<%= block.contentValue %>" style="height: 80px; margin-bottom: 5px;">
                      <input type="file" class="form-control mb-2" name="contentFile" accept="image/*">
                      <input type="hidden" name="existingImage" value="<%= block.contentValue %>">
                    </div>
                  <input type="text" class="form-control" name="contentCaption" value="<%= block.caption %>">
                <% } else if (block.blockType === 'SUBHEADING') { %>
                  <input type="text" class="form-control" name="contentValue" value="<%= block.contentValue %>">
                <% } %>
              </div>
            </div>
          <% }); %>
        </div>

        <!-- Add Content Trigger -->
        <div id="addContentTrigger" class="dashed-area" onclick="toggleOptions(true)">
          + Tambah Detail Berita
        </div>

        <!-- Content Type Options -->
        <div id="contentTypeOptions" class="content-type-selector" style="display: none;">
          <button type="button" class="btn btn-primary" onclick="addBlock('paragraph')">üìù Paragraf</button>
          <button type="button" class="btn btn-primary" onclick="addBlock('video')">üé• Video</button>
          <button type="button" class="btn btn-primary" onclick="addBlock('image')">üñºÔ∏è Gambar</button>
          <button type="button" class="btn btn-primary" onclick="addBlock('subheading')">H2 Sub Heading</button>
          <button type="button" class="btn btn-outline text-red" onclick="toggleOptions(false)">‚ùå Batal</button>
        </div>

        <div class="form-actions">
          <a href="management.html" class="btn btn-outline"
            style="border-color: #007bff; color: #333; text-align: center; text-decoration: none;">
            Batal
          </a>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    const contentContainer = document.getElementById('contentContainer');
    const addTrigger = document.getElementById('addContentTrigger');
    const optionsDiv = document.getElementById('contentTypeOptions');

    function toggleOptions(show) {
        if (show) {
            window.scrollTo(0, document.body.scrollHeight);
            addTrigger.style.display = 'none';
            optionsDiv.style.display = 'flex';
        } else {
            addTrigger.style.display = 'block';
            optionsDiv.style.display = 'none';
        }
    }

    function createRemoveBtn(elementToRemove) {
        const btn = document.createElement('button');
        btn.className = 'remove-block-btn';
        btn.innerHTML = 'üóëÔ∏è';
        btn.type = 'button';
        btn.onclick = () => elementToRemove.remove();
        return btn;
    }

    function addBlock(type) {
        const blockDiv = document.createElement('div');
        blockDiv.className = 'content-block';
        blockDiv.dataset.type = type;

        blockDiv.appendChild(createRemoveBtn(blockDiv));
        const label = document.createElement('label');
        label.className = 'form-label';
        
        // Labeling
        const labels = {
            'paragraph': 'üìù Paragraf',
            'video': 'üé• Video (URL)',
            'image': 'üñºÔ∏è Gambar Konten',
            'subheading': 'H2 Sub Heading'
        };
        label.textContent = labels[type];

        let inputContainer = document.createElement('div');

        if (type === 'paragraph') {
            const input = document.createElement('textarea');
            input.className = 'form-control';
            input.name = 'contentValue';
            input.rows = 4;
            input.placeholder = 'Tulis paragraf disini...';
            inputContainer.appendChild(input);

        } else if (type === 'video') {
            const urlInput = document.createElement('input');
            urlInput.type = 'text';
            urlInput.className = 'form-control mb-2';
            urlInput.name = 'contentValue';
            urlInput.placeholder = 'Masukkan URL Video YouTube...';
            
            const capInput = document.createElement('input');
            capInput.type = 'text';
            capInput.className = 'form-control';
            capInput.name = 'contentCaption';
            capInput.placeholder = 'Keterangan video (opsional)...';
            
            inputContainer.appendChild(urlInput);
            inputContainer.appendChild(capInput);

        } else if (type === 'image') {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.className = 'form-control mb-2';
            fileInput.name = 'contentFile'; // Hanya sementara di FE
            fileInput.accept = 'image/*';
            
            const capInput = document.createElement('input');
            capInput.type = 'text';
            capInput.className = 'form-control';
            capInput.name = 'contentCaption';
            capInput.placeholder = 'Keterangan gambar (opsional)...';
            
            inputContainer.appendChild(fileInput);
            inputContainer.appendChild(capInput);

        } else if (type === 'subheading') {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.name = 'contentValue';
            input.placeholder = 'Judul Sub-heading...';
            inputContainer.appendChild(input);
        }

        blockDiv.appendChild(label);
        blockDiv.appendChild(inputContainer);
        contentContainer.appendChild(blockDiv);
        toggleOptions(false);
    }

    // Handler Submit Form
    document.getElementById('newsForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        console.log("step 1");
        
        const formData = new FormData();
        
        // 1. Ambil data utama sesuai kunci di Controller BE
        const title = document.getElementById('newsTitle').value;
        const authorName = document.getElementById('newsAuthor').value;
        const category = document.getElementById('newsCategory').value;
        const status = 'PUBLISHED'; // Atau sesuaikan jika ada inputnya
        const thumbnailFile = document.getElementById('newsThumbnail').files[0];

        console.log("step 2");

        formData.append('title', title);
        formData.append('authorName', authorName);
        formData.append('category', category);
        formData.append('status', status);

        console.table(title, authorName, category, status);

        console.log("step 3");
        
        if (thumbnailFile) {
            formData.append('thumbnailImage', thumbnailFile); // Sesuai BE: req.files['thumbnailImage']
        }

        console.log("step 4");

        // 2. Olah Content Blocks
        const blocks = contentContainer.querySelectorAll('.content-block');
        const contentBlocksData = [];

        console.log("step 5");

        blocks.forEach((block) => {
            let type = block.dataset.type;
            type = type.toUpperCase();
            const item = { blockType: type };

            if (type === 'PARAGRAPH' || type === 'SUBHEADING' || type === 'VIDEO') {
                item.contentValue = block.querySelector('[name="contentValue"]').value;
                console.log(item.value);
                
                if (type === 'VIDEO') {
                    item.caption = block.querySelector('[name="contentCaption"]').value;
                    console.log(item.caption);
                    
                }
            } else if (type === 'IMAGE') {
                const fileInput = block.querySelector('[name="contentFile"]');
                const existingImagePath = block.querySelector('[name="existingImage"]');
                const captionInput = block.querySelector('[name="contentCaption"]');
                // if (fileInput.files.length > 0) {
                //     // Masukkan file ke key 'contentImages' sesuai BE
                //     formData.append('contentImages', fileInput.files[0]);
                //     item.value = fileInput.files[0].name; // Referensi nama file
                // }
                // item.caption = block.querySelector('[name="contentCaption"]').value;
                if (fileInput && fileInput.files.length > 0) {
            // Jika ada file baru yang diupload
            formData.append('contentImages', fileInput.files[0]);
            item.contentValue = fileInput.files[0].name; // Ini hanya sebagai tanda ada file
            } else if (existingImagePath) {
                // JIKA TIDAK ADA FILE BARU: Kirimkan path lama agar lolos validasi
                item.contentValue = existingImagePath.value; 
            } else {
                item.contentValue = ""; // Akan memicu error validasi karena benar-benar kosong
            }

            item.caption = captionInput ? captionInput.value : "";
            }
            contentBlocksData.push(item);
        });

        console.log(contentBlocksData);

        // Kirim metadata blok sebagai string JSON (Standar multipart/form-data untuk array of objects)
        formData.append('contentBlocks', JSON.stringify(contentBlocksData));

        try {
            let url = '/' + '<%= data.id %>';
            const response = await fetch( url, {
                method: 'PUT',
                body: formData
                // Jangan set Header Content-Type, browser akan otomatis mengurusnya untuk FormData
            });

            const result = await response.json();

            if (response.ok && result.success) {
                alert('Berita berhasil disimpan!');
                window.location.href = '/berita/cms-admin/list';
            } else {
                alert('Gagal membuat berita: ' + (result.error || 'Terjadi kesalahan server'));
            }
        } catch (error) {
            console.error('Error saat submit:', error);
            alert('Terjadi kesalahan koneksi ke server. ' + error.message);
        }
    });
  </script>
</body>

</html>